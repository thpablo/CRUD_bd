{% extends 'base.html' %}

{% block title %}Editar Pessoa{% endblock %}

{% block content %}
<h1>Editar Pessoa</h1>

{% if pessoa %}
<form action="{{ url_for('edit_pessoa', cpf=pessoa.cpf) }}" method="post">

    <div class="form-section">
        <h2>Informações Básicas</h2>
        <div>
            <label for="cpf">CPF:</label>
            <input type="text" id="cpf" name="cpf" value="{{ pessoa.cpf }}" readonly>
        </div>
        <div>
            <label for="nome">Nome Completo: *</label>
            <input type="text" id="nome" name="nome" value="{{ pessoa.nome }}" required>
        </div>
        <div>
            <label for="nomesocial">Nome Social (Opcional):</label>
            <input type="text" id="nomesocial" name="nomesocial" value="{{ pessoa.lgbt_info.nomesocial if pessoa.lgbt_info else '' }}">
        </div>
    </div>

    <div class="form-section">
        <h2>Contatos</h2>
        <div id="emails-container">
            <label>E-mails:</label>
            {% for email in pessoa.emails %}
            <div class="email-entry">
                <input type="email" name="emails[]" value="{{ email.email }}" placeholder="exemplo@dominio.com">
                <button type="button" onclick="this.parentElement.remove()">Remover</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addEmailInput()">Adicionar Outro E-mail</button>

        <div id="telefones-container" style="margin-top: 20px;">
            <label>Telefones:</label>
            {% for telefone in pessoa.telefones %}
            <div class="telefone-entry">
                <input type="tel" name="telefones[]" value="{{ telefone.telefone }}" placeholder="(00) 91234-5678">
                <button type="button" onclick="this.parentElement.remove()">Remover</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addTelefoneInput()">Adicionar Outro Telefone</button>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button type="submit">Salvar Alterações</button>
    </div>
</form>
{% else %}
<p>Pessoa não encontrada. Por favor, volte para a <a href="{{ url_for('pessoas') }}">lista de pessoas</a> e tente novamente.</p>
{% endif %}

<script>
// --- Event Listeners ---
document.getElementById('is_aluno')?.addEventListener('change', (e) => toggleSection('aluno_fields', e.target.checked));
document.getElementById('is_servidor')?.addEventListener('change', (e) => toggleSection('servidor_fields', e.target.checked));
document.querySelectorAll('.pcd-checkbox').forEach(cb => cb.addEventListener('change', updatePcdDetailsVisibility));
document.querySelectorAll('.membro-checkbox').forEach(cb => cb.addEventListener('change', updateMembroDetailsVisibility));

/**
 * Updates the 'required' attribute on all form elements within a given section.
 * @param {HTMLElement} section The container element of the section.
 * @param {boolean} isRequired Whether the fields should be required or not.
 */
function updateRequiredAttributes(section, isRequired) {
    if (!section) return;
    // Find all inputs that were originally required
    const inputs = section.querySelectorAll('[data-original-required]');
    inputs.forEach(input => {
        input.required = isRequired;
    });
}

function toggleSection(sectionId, isVisible) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.style.display = isVisible ? 'block' : 'none';
        updateRequiredAttributes(section, isVisible);
    }
}

function updatePcdDetailsVisibility() {
    const isAnyPcd = Array.from(document.querySelectorAll('.pcd-checkbox')).some(cb => {
        return cb.offsetParent !== null && cb.checked;
    });
    toggleSection('pcd_details', isAnyPcd);
}

function updateMembroDetailsVisibility() {
    const isAnyMembro = Array.from(document.querySelectorAll('.membro-checkbox')).some(cb => {
        return cb.offsetParent !== null && cb.checked;
    });
    toggleSection('membro_details', isAnyMembro);
}

function showServidorSubFields() {
    const tipo = document.getElementById("tipo_servidor")?.value;
    document.querySelectorAll('.servidor-sub-section').forEach(sec => {
        sec.style.display = 'none';
        updateRequiredAttributes(sec, false);
    });
    if (tipo) {
        const section = document.getElementById(tipo + "_fields");
        if (section) {
            section.style.display = "block";
            updateRequiredAttributes(section, true);
        }
    }
    updatePcdDetailsVisibility();
    updateMembroDetailsVisibility();
}

// --- Dynamic Input Adders for Contacts ---
function addEmailInput() {
    const container = document.getElementById('emails-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'email-entry';
    newEntry.innerHTML = '<input type="email" name="emails[]" placeholder="exemplo@dominio.com"> <button type="button" onclick="this.parentElement.remove()">Remover</button>';
    container.appendChild(newEntry);
}

function addTelefoneInput() {
    const container = document.getElementById('telefones-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'telefone-entry';
    newEntry.innerHTML = '<input type="tel" name="telefones[]" placeholder="(00) 91234-5678"> <button type="button" onclick="this.parentElement.remove()">Remover</button>';
    container.appendChild(newEntry);
}

function addDeficienciaInput() {
    const container = document.getElementById('deficiencias-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'deficiencia-entry';
    const originalSelect = document.querySelector('[name="deficiencias[]"]');
    newEntry.innerHTML = `
        ${originalSelect.outerHTML}
        <input type="text" name="graus[]" placeholder="Grau (leve, intermediário, severo)">
        <input type="text" name="observacoes[]" placeholder="Observação">
        <button type="button" onclick="this.parentElement.remove()">Remover</button>
    `;
    container.appendChild(newEntry);
}

// --- Initial State Setup ---
document.addEventListener('DOMContentLoaded', () => {
    // Mark originally required fields and make them not required initially
    document.querySelectorAll('[required]').forEach(input => {
        input.setAttribute('data-original-required', 'true');
        // We don't set to false immediately, we let the toggle functions handle it
    });

    // Initial setup based on checked status on page load
    const isAlunoCheckbox = document.getElementById('is_aluno');
    if (isAlunoCheckbox) {
        toggleSection('aluno_fields', isAlunoCheckbox.checked);
    }
    const isServidorCheckbox = document.getElementById('is_servidor');
    if (isServidorCheckbox) {
        toggleSection('servidor_fields', isServidorCheckbox.checked);
    }
    showServidorSubFields(); // This also calls the visibility updates for sub-sections
});
</script>
{% endblock %}
